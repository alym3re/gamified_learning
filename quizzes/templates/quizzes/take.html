{% extends 'base.html' %}
{% block title %}Take Quiz - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="container quiz-container">
    <h1 class="mb-4">{{ quiz.title }}</h1>
    
    {% if quiz.description %}
        <div class="alert alert-info mb-4">
            {{ quiz.description }}
        </div>
    {% endif %}
    
    <div class="quiz-info mb-4">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5>Time Remaining: <span id="time-remaining">{% if quiz.time_limit > 0 %}{{ quiz.time_limit }}:00{% else %}No limit{% endif %}</span></h5>
                    </div>
                    <div>
                        <h5>Questions: {{ questions|length }}</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="quiz-form">
        {% csrf_token %}
        {% for question in questions %}
        <div class="card mb-3 question-card">
            <div class="card-header">
                <h5>Question {{ forloop.counter }}</h5>
                <span class="badge bg-info">{{ question.get_question_type_display }}</span>
                <small class="text-muted">{{ question.points }} point{{ question.points|pluralize }}</small>
            </div>
            <div class="card-body">
                <p class="card-text">{{ question.text }}</p>
                <div class="answers">
                    {% if question.question_type == "multiple_single" %}
                        {% for choice in question.choices.all %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="choice_{{ question.id }}"
                                   id="answer_{{ question.id }}_{{ choice.id }}"
                                   value="{{ choice.id }}" required>
                            <label class="form-check-label" for="answer_{{ question.id }}_{{ choice.id }}">
                                {{ choice.text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% elif question.question_type == "multiple_multi" %}
                        {% for choice in question.choices.all %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="choice_{{ question.id }}"
                                   id="answer_{{ question.id }}_{{ choice.id }}"
                                   value="{{ choice.id }}">
                            <label class="form-check-label" for="answer_{{ question.id }}_{{ choice.id }}">
                                {{ choice.text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% elif question.question_type == "true_false" %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="tf_{{ question.id }}"
                                   id="tf_{{ question.id }}_true"
                                   value="True" required>
                            <label class="form-check-label" for="tf_{{ question.id }}_true">True</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio"
                                   name="tf_{{ question.id }}"
                                   id="tf_{{ question.id }}_false"
                                   value="False" required>
                            <label class="form-check-label" for="tf_{{ question.id }}_false">False</label>
                        </div>
                    {% elif question.question_type == "identification" %}
                        <input type="text" class="form-control" name="ident_{{ question.id }}" placeholder="Your answer here..." required>
                    {% else %}
                        {% for answer in question.answers.all %}
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                   name="question_{{ question.id }}" 
                                   id="answer_{{ question.id }}_{{ answer.id }}" 
                                   value="{{ answer.id }}" required>
                            <label class="form-check-label" for="answer_{{ question.id }}_{{ answer.id }}">
                                {{ answer.text }}
                            </label>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        <button type="submit" class="btn btn-primary btn-lg">Submit Quiz</button>
    </form>
</div>
{% endblock %}

{% block js %}
<script>
// Timer implementation
{% if quiz.time_limit > 0 %}
    let duration = {{ quiz.time_limit }} * 60; // Convert to seconds
    const timerElement = document.getElementById('time-remaining');

    function updateTimer() {
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;
        timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        if (duration <= 0) {
            document.getElementById('quiz-form').submit();
        } else {
            duration--;
            setTimeout(updateTimer, 1000);
        }
        
        // Add warning class when less than 5 minutes remain
        if (duration < 300) { // 5 minutes = 300 seconds
            timerElement.classList.add('text-danger');
            timerElement.classList.add('fw-bold');
        }
    }

    // Start timer when page loads
    updateTimer();
{% endif %}


// Prevent accidental navigation
window.addEventListener('beforeunload', function(e) {
    if (!document.getElementById('quiz-form').checkValidity()) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    }
});
</script>
{% endblock %}
